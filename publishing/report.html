
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ ì§€ë³´ìˆ˜ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="/css/common.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=tyuobfazcq"></script>
</head>

<body>
    <div class="container-fluid">
        <header>
            <nav class="navbar navbar-expand-lg navbar-light main-nav">
                <a class="navbar-brand" href="/">í†µí•© í”„ë¡œì íŠ¸ ëŒ€ì‹œë³´ë“œ</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="mainNavbar">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item"><a class="nav-link" href="/addlist">í”„ë¡œì íŠ¸ ê´€ë¦¬</a></li><li class="nav-item"><a class="nav-link" href="/car_record">ì°¨ëŸ‰ ìš´í–‰ ê¸°ë¡ë¶€</a></li><li class="nav-item"><a class="nav-link" href="/maintenance">ìœ ì§€ë³´ìˆ˜ ê´€ë¦¬ ì‹œìŠ¤í…œ</a></li><li class="nav-item"><a class="nav-link" href="/out">ì¶œì¥ ê¸°ë¡ ë¶„ì„</a></li><li class="nav-item"><a class="nav-link" href="/smallriver">ì†Œí•˜ì²œ ê´€ë¦¬</a></li><li class="nav-item"><a class="nav-link" href="/gantt_chart">ê°„íŠ¸ì°¨íŠ¸ ì„ì‹œ</a></li><li class="nav-item"><a class="nav-link" href="http://woobo.online/">ì‹œìŠ¤í…œì‚¬ì—…ë¶€</a></li><li class="nav-item"><a class="nav-link" href="http://wbsystem.dscloud.mobi:8888/">WIKI ìš°ë³´ì¬ë‚œ</a></li><li class="nav-item"><a class="nav-link" href="/work_reports">ì—…ë¬´ ë³´ê³  ì‹œìŠ¤í…œ</a></li><li class="nav-item"><a class="nav-link" href="/gpsmap">GPS ê¸°ë¡í•˜ê¸°</a></li>                    </ul>
                </div>
            </nav>
        </header>
        <main><link rel="stylesheet" href="/css/mobile_compact.css?v=1768464236"><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- Inline Styles Removed: Using system/css/mobile_compact.css -->
<style>
    /* Specific video container style that might not be in global yet, or kept for specific logic */
    #video-container {
        position: relative;
        width: 100%;
        padding-top: 56.25%;
        background-color: #333;
        overflow: hidden;
    }

    #video-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
</style>

<div class="container mt-2 m-p-0">
    <div class="d-flex justify-content-between align-items-center mb-2 m-p-2">
        <h1 class="m-text-md font-weight-bold m-0">ìƒì£¼ ìš©ìœ ì²œ ìƒì„¸ ì •ë³´</h1>
        <div class="btn-group">
            <a href="javascript:history.back()" class="btn btn-secondary btn-sm m-text-xs">ëª©ë¡</a>
            <button type="button" class="btn btn-success btn-sm m-text-xs" id="view-snapshots-btn">ì‚¬ì§„</button>
            <a href="report.php?id=10" target="_blank" class="btn btn-info btn-sm m-text-xs">ë³´ê³ ì„œ</a>
            <a href="edit.php?id=10" class="btn btn-primary btn-sm m-text-xs">ìˆ˜ì •</a>
        </div>
    </div>

    <div class="row m-0">
        <div class="col-lg-7 p-1">
            <div class="card mb-2 mobile-card">
                <div class="card-header p-2">
                    <h5 class="m-0 m-text-md font-weight-bold">ì¢…í•© ì •ë³´</h5>
                </div>
                <div class="card-body p-0">
                    <table class="table table-bordered table-sm table-key-value m-0">
                        <tr>
                            <th>ì£¼ì†Œ</th>
                            <td>ê²½ìƒë¶ë„ ìƒì£¼ì‹œ í™”ë¶ë©´ ìš©ìœ ë¦¬ 601(ìš©ìœ êµ)</td>
                        </tr>
                        <tr>
                            <th>ì¢…í•© ìƒíƒœ</th>
                            <td><span class="badge badge-success">Operational</span></td>
                        </tr>
                        <tr>
                            <th>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</th>
                            <td>2026-01-10 20:46:00</td>
                        </tr>
                        <tr>
                            <th>ì„¤ì¹˜ì¼</th>
                            <td>2023-06-13</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="card mb-2 mobile-card">
                <div class="card-header p-2">
                    <h5 class="m-0 m-text-md font-weight-bold">ì‹¤ì‹œê°„ ê³„ì¸¡ ì •ë³´ (ìµœì¢…)</h5>
                </div>
                <div class="card-body p-0">
                                        <table class="table table-bordered table-sm table-key-value m-0">
                        <tr>
                            <th>ê³„ì¸¡ ì‹œê°„</th>
                            <td colspan="3">2026-01-15 17:00:00</td>
                        </tr>
                        <tr>
                            <th>ìˆ˜ìœ„(GL)</th>
                            <td>0.411 m</td>
                            <th>í‰ê·  ìœ ì†</th>
                            <td>00.129 m/s</td>
                        </tr>
                        <tr>
                            <th>ë°”ë‹¥ê¸°ì¤€(EL)</th>
                            <td>274.364 m</td>
                            <th>ì´ ìœ ëŸ‰</th>
                            <td>00.540 mÂ³/s</td>
                        </tr>
                        <tr>
                            <th>í•©ì‚°ìˆ˜ìœ„(FL)</th>
                            <td>274.775 m</td>
                            <th></th>
                            <td></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="card mb-2 mobile-card">
                <div class="card-header p-2">
                    <h5 class="m-0 m-text-md font-weight-bold">ìˆ˜ìœ„ ë³€í™”ëŸ‰(72ì‹œê°„)</h5>
                </div>
                <!-- Chart height can be tricky, keep some padding -->
                <div class="card-body p-2">
                    <div id="chart-loader" class="text-center p-3">
                        <div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div>
                        <p class="mt-2 m-text-xs">ë°ì´í„° ë¡œë”© ì¤‘...</p>
                    </div>
                    <div id="chart-container" class="row m-0" style="display: none;">
                        <div class="col-md-12 p-0">
                            <div style="position: relative; height:250px; width:100%">
                                <canvas id="waterLevelChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-2 mobile-card">
                <div class="card-header p-2">
                    <h5 class="m-0 m-text-md font-weight-bold">ì¥ë¹„ ì§„ë‹¨ ì •ë³´</h5>
                </div>
                <div class="card-body p-0">
                                        <table class="table table-bordered table-sm table-key-value m-0">
                        <tr>
                            <th>S/W ë²„ì „</th>
                            <td>1.4.4.0</td>
                            <th>F/W ë²„ì „</th>
                            <td>-</td>
                        </tr>
                        <tr>
                            <th>ë§ˆì§€ë§‰ ì¬ë¶€íŒ…</th>
                            <td colspan="3">-</td>
                        </tr>
                        <tr>
                            <th>ìˆ˜ìœ„ê³„ ìƒíƒœ</th>
                            <td><span class="text-success font-weight-bold">ì •ìƒ</span></td>
                            <th>ìœ ì†ê³„ ìƒíƒœ</th>
                            <td><span class="text-success font-weight-bold">ì •ìƒ</span></td>
                        </tr>
                        <tr>
                            <th>ì—°ì‚°ì¥ì¹˜</th>
                            <td><span class="text-success font-weight-bold">ì •ìƒ</span></td>
                            <th>UPS ìƒíƒœ</th>
                            <td><span class="text-success font-weight-bold">ì •ìƒ</span></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-lg-5 p-1">
            <div class="card mb-2 mobile-card">
                <div class="card-header p-2">
                    <h5 class="m-0 m-text-md font-weight-bold">ì‹¤ì‹œê°„ ì˜ìƒ <a href="notpage/index.php" target="_blank" class="badge badge-warning m-text-xs" style="vertical-align: middle;">ì¬ìƒë¶ˆê°€ ë„ì›€ë§</a></h5>
                </div>
                <div class="card-body p-2">
                                                                    <div class="alert alert-success small" role="alert">ì¥ë¹„ì™€ í†µì‹ ì´ ì •ìƒì…ë‹ˆë‹¤. ì‹¤ì‹œê°„ ì˜ìƒ ì¬ìƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
                        <div id="video-container" style="background-color: #333;">
                            <canvas id="video-canvas"></canvas>
                        </div>
                        <div class="mt-2 d-flex align-items-center">
                            <button id="play-stream-btn" class="btn btn-success">ì˜ìƒ ì¬ìƒ</button>
                            <button id="stop-stream-btn" class="btn btn-danger" style="display: none;">ì¬ìƒ ì¤‘ì§€</button>
                            <span id="stream-status" class="ml-2 font-weight-bold text-muted"></span>
                        </div>
                                    </div>
            </div>

            <div class="card mb-2 mobile-card">
                <div class="card-header p-2">
                    <h5 class="m-0 m-text-md font-weight-bold">ì¥ë¹„ ìœ„ì¹˜</h5>
                </div>
                <!-- Map needs height. Keep inline height but ensure it fits. -->
                <div class="card-body p-2">
                    <div id="map" style="height: 250px; border: 1px solid #ddd; border-radius: 5px;"></div>
                    <p class="text-muted mt-1 mb-1 m-text-xs">ìœ„ë„: 36.57228300, ê²½ë„: 127.93045600</p>
                    <div class="d-flex" style="gap: 5px;">
                        <button type="button" class="btn btn-outline-secondary btn-sm flex-fill m-text-xs" onclick="copyAddress('ê²½ìƒë¶ë„ ìƒì£¼ì‹œ í™”ë¶ë©´ ìš©ìœ ë¦¬ 601(ìš©ìœ êµ)')">
                            <i class="fas fa-copy"></i> ì£¼ì†Œ ë³µì‚¬
                        </button>
                        <a href="https://map.naver.com/v5/search/%EA%B2%BD%EC%83%81%EB%B6%81%EB%8F%84+%EC%83%81%EC%A3%BC%EC%8B%9C+%ED%99%94%EB%B6%81%EB%A9%B4+%EC%9A%A9%EC%9C%A0%EB%A6%AC+601%28%EC%9A%A9%EC%9C%A0%EA%B5%90%29" target="_blank" class="btn btn-outline-success btn-sm flex-fill m-text-xs">
                            <i class="fas fa-map-marked-alt"></i> ë„¤ì´ë²„ ì§€ë„
                        </a>
                    </div>
                </div>
                <script>
                    function copyAddress(address) {
                        if (!address) {
                            alert('ë³µì‚¬í•  ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }
                        navigator.clipboard.writeText(address).then(function() {
                            alert('ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ' + address);
                        }, function(err) {
                            console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                            // Fallback
                            const textArea = document.createElement("textarea");
                            textArea.value = address;
                            document.body.appendChild(textArea);
                            textArea.select();
                            try {
                                document.execCommand('copy');
                                alert('ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ' + address);
                            } catch (err) {
                                console.error('Fallback: Oops, unable to copy', err);
                                prompt("ì´ ì£¼ì†Œë¥¼ ì§ì ‘ ë³µì‚¬í•˜ì„¸ìš”:", address);
                            }
                            document.body.removeChild(textArea);
                        });
                    }
                </script>
            </div>

            <div class="card mb-2 mobile-card">
                <div class="card-header p-2">
                    <h5 class="m-0 m-text-md font-weight-bold">ë„¤íŠ¸ì›Œí¬ ì •ë³´</h5>
                </div>
                <div class="card-body p-0">
                    <table class="table table-bordered table-sm table-key-value m-0">
                        <tr>
                            <th>Public IP</th>
                            <td>121.159.32.189</td>
                        </tr>
                        <tr>
                            <th>Gateway IP</th>
                            <td>121.159.32.190</td>
                        </tr>
                        <tr>
                            <th>VPN Gateway</th>
                            <td>10.54.12.1</td>
                        </tr>
                        <tr>
                            <th>RTSP URL</th>
                            <td>rtsp://admin:1234@121.159.32.189:4020/video1</td>
                        </tr>
                        <tr>
                            <th>API Key</th>
                            <td>5aa261fb-4856-33ec-bc79-33e29f78a691</td>
                        </tr>
                        <tr>
                            <th>ì›ê²© ID</th>
                            <td>47 046 647</td>
                        </tr>
                        <tr>
                            <th>ì›ê²© P/W</th>
                            <td>Woobosys4781!</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="snapshotModal" tabindex="-1" role="dialog" aria-labelledby="snapshotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="snapshotModalLabel">ìŠ¤ëƒ…ìƒ· ë·°ì–´</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="snapshot-gallery" style="max-height: 80vh; overflow-y: auto;">
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="lightboxModal" tabindex="-1" aria-labelledby="lightboxModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="background-color: rgba(0,0,0,0.8);">
            <div class="modal-header" style="border-bottom: none;">
                <h5 class="modal-title text-white" id="lightboxModalLabel"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #fff; opacity: 1;">&times;</button>
            </div>
            <div class="modal-body text-center">
                <img src="" id="lightboxImage" class="img-fluid" style="max-height: 80vh;">
            </div>
            <div class="modal-footer justify-content-between" style="border-top: none;">
                <button type="button" class="btn btn-light" id="lightboxPrev">&larr; ì´ì „</button>
                <button type="button" class="btn btn-light" id="lightboxNext">ë‹¤ìŒ &rarr;</button>
            </div>
        </div>
    </div>
</div>


<script>
    // ğŸš¨ config.php ìˆ˜ì • ì—†ì´ WEB_HOST ìƒì„±
    const protocol = window.location.protocol;
    const host = window.location.host;
    window.WEB_HOST = `${protocol}//${host}`;

    // PHPì—ì„œ ì •ì˜í•œ BASE_URL ìƒìˆ˜ë¥¼ JavaScriptë¡œ ì „ë‹¬ (ì„ íƒ ì‚¬í•­, ë‹¤ë¥¸ ê³³ì—ì„œ ì‚¬ìš©ë  ìˆ˜ ìˆìŒ)
    window.APP_BASE_URL = "";
</script>
<script src="https://woobo.duckdns.org:9999/jsmpeg.js"></script>
<script src="/js/rtsp-player.js"></script>
<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=tyuobfazcq"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const viewSnapshotsBtn = document.getElementById('view-snapshots-btn');
        // Bootstrap 4 uses jQuery for modals, so we don't need new bootstrap.Modal()
        const galleryContainer = document.getElementById('snapshot-gallery');
        const locationId = 10;

        // --- íŒŒì¼ëª… íŒŒì‹± í•¨ìˆ˜ (KST) ---
        function parseFilenameToKstDate(url) {
            const filename = url.substring(url.lastIndexOf('/') + 1);
            const match = filename.match(/_(\d{8})_(\d{6})\.jpg$/);

            if (match) {
                const dateStr = match[1];
                const timeStr = match[2];
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                const hour = timeStr.substring(0, 2);
                const minute = timeStr.substring(2, 4);
                const second = timeStr.substring(4, 6);

                const kstIsoStr = `${year}-${month}-${day}T${hour}:${minute}:${second}+09:00`;
                return new Date(kstIsoStr);
            }
            return null;
        }
        // ----------------------------

        // --- Lightbox variables and functions ---
        let allSnapshots = [];
        let currentLightboxIndex = -1;
        const lightboxImage = document.getElementById('lightboxImage');
        const lightboxTitle = document.getElementById('lightboxModalLabel');
        const lightboxPrevBtn = document.getElementById('lightboxPrev');
        const lightboxNextBtn = document.getElementById('lightboxNext');

        function showLightbox(index) {
            if (index < 0 || index >= allSnapshots.length) return;

            currentLightboxIndex = index;
            const snapshot = allSnapshots[index];

            const relativePath = snapshot.url.startsWith('/system') ? snapshot.url.substring('/system'.length) : snapshot.url;
            const absoluteUrl = window.WEB_HOST + relativePath;

            lightboxImage.src = absoluteUrl;

            // íŒŒì¼ëª…ì—ì„œ ì‹œê°„ íŒŒì‹± ë° KSTë¡œ í‘œì‹œ (ë¼ì´íŠ¸ë°•ìŠ¤ ì œëª©ìš©)
            const kstDate = parseFilenameToKstDate(absoluteUrl);
            if (kstDate) {
                lightboxTitle.textContent = kstDate.toLocaleString('ko-KR');
            } else {
                lightboxTitle.textContent = 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
            }

            if (lightboxPrevBtn) lightboxPrevBtn.disabled = (currentLightboxIndex === 0);
            if (lightboxNextBtn) lightboxNextBtn.disabled = (currentLightboxIndex === allSnapshots.length - 1);

            $('#snapshotModal').modal('hide'); // BS4 Hide
            $('#lightboxModal').modal('show'); // BS4 Show
        }

        if (lightboxPrevBtn) {
            lightboxPrevBtn.addEventListener('click', () => {
                if (currentLightboxIndex > 0) showLightbox(currentLightboxIndex - 1);
            });
        }
        if (lightboxNextBtn) {
            lightboxNextBtn.addEventListener('click', () => {
                if (currentLightboxIndex < allSnapshots.length - 1) showLightbox(currentLightboxIndex + 1);
            });
        }

        // Handle Lightbox close to reopen gallery (Optional, but good UX)
        $('#lightboxModal').on('hidden.bs.modal', function() {
            $('#snapshotModal').modal('show');
        });
        // --- End of Lightbox ---

        if (viewSnapshotsBtn) {
            viewSnapshotsBtn.addEventListener('click', function() {
                galleryContainer.innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div><p class="mt-2">ìŠ¤ëƒ…ìƒ· ëª©ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤...</p></div>';
                $('#snapshotModal').modal('show'); // BS4 Show

                fetch(`get_snapshots.php?id=${locationId}`)
                    .then(response => response.json())
                    .then(data => {
                        galleryContainer.innerHTML = '';
                        allSnapshots = [];
                        let globalIndex = 0;

                        if (Object.keys(data).length === 0) {
                            galleryContainer.innerHTML = '<div class="alert alert-warning">í‘œì‹œí•  ìŠ¤ëƒ…ìƒ·ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                            return;
                        }

                        const sortedDates = Object.keys(data).sort((a, b) => new Date(b) - new Date(a));

                        // --- Accordion Setup ---
                        const accordionId = 'snapshotAccordion';
                        galleryContainer.innerHTML = `<div class="accordion" id="${accordionId}"></div>`;
                        const accordionContainer = galleryContainer.querySelector('.accordion');

                        const today = new Date();
                        const pad = n => n.toString().padStart(2, '0');
                        const getYmd = d => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
                        const todayStr = getYmd(today);

                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayStr = getYmd(yesterday);

                        sortedDates.forEach((date, index) => {
                            let snapshots = data[date];

                            // Sort snapshots by time (Descending: Newest first)
                            snapshots.sort((a, b) => {
                                const urlA = a.url.startsWith('/system') ? a.url.substring('/system'.length) : a.url;
                                const urlB = b.url.startsWith('/system') ? b.url.substring('/system'.length) : b.url;
                                const dateA = parseFilenameToKstDate(window.WEB_HOST + urlA) || new Date(0);
                                const dateB = parseFilenameToKstDate(window.WEB_HOST + urlB) || new Date(0);
                                return dateB - dateA;
                            });

                            // Add to global list for lightbox
                            snapshots.forEach(s => allSnapshots.push({
                                ...s,
                                date: date
                            }));

                            // Label Logic
                            const dObj = new Date(date);
                            const monthDay = `${dObj.getMonth() + 1}ì›” ${dObj.getDate()}ì¼`;
                            let dateLabel = `<strong>${monthDay}</strong>`;

                            if (date === todayStr) dateLabel += ' <span class="badge badge-primary ml-1">ì˜¤ëŠ˜</span>'; // BS4 badge class
                            else if (date === yesterdayStr) dateLabel += ' <span class="badge badge-secondary ml-1">ì–´ì œ</span>'; // BS4 badge class

                            // IDs
                            const headingId = `heading-${date}`;
                            const collapseId = `collapse-${date}`;
                            const isFirst = index === 0;
                            const showClass = isFirst ? 'show' : '';
                            const collapsedClass = isFirst ? '' : 'collapsed';
                            const expandedAttr = isFirst ? 'true' : 'false';

                            // Generate Image Grid HTML
                            let imagesHtml = '';
                            snapshots.forEach(snapshot => {
                                const relativePath = snapshot.url.startsWith('/system') ? snapshot.url.substring('/system'.length) : snapshot.url;
                                const absoluteUrl = window.WEB_HOST + relativePath;
                                const kstDate = parseFilenameToKstDate(absoluteUrl);

                                let displayTime = 'N/A';
                                if (kstDate) {
                                    displayTime = kstDate.toLocaleTimeString('ko-KR', {
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        second: '2-digit',
                                        hour12: false
                                    });
                                }

                                imagesHtml += `
                                    <div class="col-md-3 mb-3">
                                        <a href="${absoluteUrl}" class="snapshot-thumbnail" data-index="${globalIndex}" style="cursor: pointer;">
                                            <img src="${absoluteUrl}" class="img-fluid rounded border" alt="${displayTime}" loading="lazy"
                                                 onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'d-flex align-items-center justify-content-center bg-light border rounded\' style=\'height:100%; min-height:150px;\'><span class=\'text-muted small\'>ì´ë¯¸ì§€ ì—†ìŒ</span></div>';">
                                        </a>
                                        <p class="text-center small text-muted mt-1">${displayTime}</p>
                                    </div>`;
                                globalIndex++;
                            });

                            // Accordion Item HTML (Bootstrap 4 Syntax)
                            // data-toggle="collapse", data-target, data-parent
                            const itemHtml = `
                                <div class="card">
                                    <div class="card-header" id="${headingId}">
                                        <h2 class="mb-0">
                                            <button class="btn btn-link btn-block text-left ${collapsedClass}" type="button" data-toggle="collapse" data-target="#${collapseId}" aria-expanded="${expandedAttr}" aria-controls="${collapseId}" style="text-decoration:none; color:inherit;">
                                                <span class="d-flex justify-content-between align-items-center">
                                                    <span>${dateLabel}</span>
                                                    <span class="badge badge-light border">${snapshots.length}ì¥</span>
                                                </span>
                                            </button>
                                        </h2>
                                    </div>
                                    <div id="${collapseId}" class="collapse ${showClass}" aria-labelledby="${headingId}" data-parent="#${accordionId}">
                                        <div class="card-body bg-light">
                                            <div class="row">
                                                ${imagesHtml}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            accordionContainer.insertAdjacentHTML('beforeend', itemHtml);
                        });
                    })
                    .catch(error => {
                        galleryContainer.innerHTML = '<div class="alert alert-danger">ìŠ¤ëƒ…ìƒ·ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                        console.error('Error fetching snapshots:', error);
                    });
            });

            galleryContainer.addEventListener('click', function(e) {
                const thumbnailLink = e.target.closest('.snapshot-thumbnail');
                if (thumbnailLink) {
                    e.preventDefault();
                    const index = parseInt(thumbnailLink.dataset.index, 10);
                    if (!isNaN(index)) {
                        showLightbox(index);
                    }
                }
            });
        }

        const lat = 36.572283;
        const lon = 127.930456;
        if (lat && lon && window.naver && window.naver.maps) {
            const mapOptions = {
                center: new naver.maps.LatLng(lat, lon),
                zoom: 16
            };
            const map = new naver.maps.Map('map', mapOptions);
            const marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(lat, lon),
                map: map
            });
        } else {
            const mapDiv = document.getElementById('map');
            if (mapDiv) mapDiv.innerHTML = '<div class="alert alert-warning">GPS ì¢Œí‘œê°€ ì—†ì–´ ì§€ë„ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }

        const rtspUrl = "rtsp:\/\/admin:1234@121.159.32.189:4020\/video1";
        if (rtspUrl) {
            new RtspPlayer({
                rtspUrl: rtspUrl,
                container: document.getElementById('video-container'),
                canvas: document.getElementById('video-canvas'),
                playBtn: document.getElementById('play-stream-btn'),
                stopBtn: document.getElementById('stop-stream-btn'),
                statusEl: document.getElementById('stream-status'),
            });

            const videoContainer = document.getElementById('video-container');
            // ğŸ’¡ PHP ë³€ìˆ˜ ì´ë¦„ ë³€ê²½ (í˜¼ë™ ë°©ì§€)
            const latestSnapshotUrlRelative = "\/system\/uploads\/rtsp_captures\/\uc0c1\uc8fc_\uc6a9\uc720\ucc9c_\uacbd\uc0c1\ubd81\ub3c4_\uc0c1\uc8fc\uc2dc_\ud654\ubd81\uba74_\uc6a9\uc720\ub9ac_601(\uc6a9\uc720\uad50)_20260115_170005.jpg";

            function revertToSnapshot() {
                if (videoContainer && latestSnapshotUrlRelative) {
                    // ğŸš¨ ìˆ˜ì •: ì¤‘ë³µ ê²½ë¡œ ì œê±° í›„ ì ˆëŒ€ URL ì‚¬ìš© (ìµœì´ˆ ë¡œë”© ì‹œ ë°°ê²½ ì´ë¯¸ì§€)
                    const relativePath = latestSnapshotUrlRelative.startsWith('/system') ? latestSnapshotUrlRelative.substring('/system'.length) : latestSnapshotUrlRelative;
                    const absoluteSnapshotUrl = window.WEB_HOST + relativePath;

                    videoContainer.style.backgroundImage = `url('${absoluteSnapshotUrl}')`;
                    videoContainer.style.backgroundSize = 'cover';
                    videoContainer.style.backgroundPosition = 'center';
                } else if (videoContainer) {
                    videoContainer.style.backgroundColor = '#333'; // Fallback color
                }
            }
            revertToSnapshot(); // ìµœì´ˆ ë¡œë”© ì‹œ ìµœì‹  ìŠ¤ëƒ…ìƒ· í‘œì‹œ

            const playBtn = document.getElementById('play-stream-btn');
            if (playBtn) {
                playBtn.addEventListener('click', () => {
                    if (videoContainer) {
                        videoContainer.style.backgroundImage = 'none';
                        videoContainer.style.backgroundColor = '#000';
                    }
                });
            }

            const stopBtn = document.getElementById('stop-stream-btn');
            if (stopBtn) {
                stopBtn.addEventListener('click', revertToSnapshot);
            }

            const statusEl = document.getElementById('stream-status');
            if (statusEl) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList' || mutation.type === 'characterData') {
                            const newText = mutation.target.textContent.toLowerCase();
                            if (newText.includes('error') || newText.includes('failed') || newText.includes('fail')) {
                                revertToSnapshot();
                            }
                        }
                    });
                });
                observer.observe(statusEl, {
                    childList: true,
                    characterData: true,
                    subtree: true
                });
            }
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const locationId = 10;
        const enclosureHeight = null;
        const levelCritical = enclosureHeight ? (enclosureHeight * 0.9).toFixed(2) : null;
        const levelWarning = enclosureHeight ? (enclosureHeight * 0.8).toFixed(2) : null;
        const levelCaution = enclosureHeight ? (enclosureHeight * 0.7).toFixed(2) : null;

        function getStatus(waterLevel) {
            if (!enclosureHeight || !levelCritical) return {
                status: 'ì •ë³´ì—†ìŒ',
                className: 'text-muted'
            };
            const level = parseFloat(waterLevel);
            if (level >= levelCritical) return {
                status: 'ì‹¬ê°',
                className: 'text-danger'
            };
            if (level >= levelWarning) return {
                status: 'ê²½ê³„',
                className: 'text-warning'
            };
            if (level >= levelCaution) return {
                status: 'ì£¼ì˜',
                className: 'text-info'
            };
            return {
                status: 'ì •ìƒ',
                className: 'text-success'
            };
        }

        const loader = document.getElementById('chart-loader');
        const chartContainer = document.getElementById('chart-container');

        fetch(`get_water_level_history.php?id=${locationId}`)
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Server responded with ${response.status}: ${text}`);
                    });
                }
                // Clone the response to be able to read it twice (as JSON, and as text if JSON parsing fails)
                const responseClone = response.clone();
                return response.json().catch(() => {
                    return responseClone.text().then(text => {
                        throw new Error(`Failed to parse JSON. Server responded with:\n${text}`);
                    });
                });
            })
            .then(historyData => {
                if (!historyData || historyData.length === 0) {
                    loader.innerHTML = '<div class="alert alert-warning">í‘œì‹œí•  ìˆ˜ìœ„ ì´ë ¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                loader.style.display = 'none';
                chartContainer.style.display = 'flex';

                const ctx = document.getElementById('waterLevelChart').getContext('2d');
                const labels = historyData.map(d => {
                    const logDate = new Date(d.log_time);
                    return `${String(logDate.getMonth() + 1).padStart(2, '0')}-${String(logDate.getDate()).padStart(2, '0')} ${String(logDate.getHours()).padStart(2, '0')}:${String(logDate.getMinutes()).padStart(2, '0')}`;
                });
                const waterLevels = historyData.map(d => parseFloat(d.water_level));
                const avgVelocities = historyData.map(d => parseFloat(d.avg_velocity));

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ìˆ˜ìœ„ (m)',
                            data: waterLevels,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderWidth: 2,
                            pointRadius: 2,
                            yAxisID: 'y',
                        }, {
                            label: 'í‰ê·  ìœ ì† (m/s)',
                            data: avgVelocities,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 2,
                            pointRadius: 2,
                            yAxisID: 'y1',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                type: 'linear',
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'ìˆ˜ìœ„ (m)',
                                    color: '#007bff'
                                },
                                ticks: {
                                    color: '#007bff'
                                }
                            },
                            y1: {
                                type: 'linear',
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'í‰ê·  ìœ ì† (m/s)',
                                    color: '#28a745'
                                },
                                ticks: {
                                    color: '#28a745'
                                },
                                grid: {
                                    drawOnChartArea: false
                                },
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Detailed Fetch Error:', error.message);

                // Helper function to escape HTML to display it safely as text
                function escapeHtml(unsafe) {
                    return unsafe
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");
                }

                loader.innerHTML = `<div class="alert alert-danger">
                <h5>ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</h5>
                <p>ì„œë²„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ëŠ” ì„œë²„ì˜ ì‹¤ì œ ì‘ë‹µ ë‚´ìš©ì…ë‹ˆë‹¤.</p>
                <pre style="white-space: pre-wrap; word-break: break-all; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 5px;">${escapeHtml(error.message)}</pre>
            </div>`;
            });
    });
</script>

        </main>
        </div>

        <!-- Bootstrap JS and its dependencies (jQuery and Popper.js) -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

        </body>

        </html>